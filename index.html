<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RaspServerTV</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>
<header class="main-header">
  <a href="index.html" class="logo-area" style="text-decoration: none; color: inherit;">
    <img src="https://raw.githubusercontent.com/devicons/devicon/ca28c779441053191ff11710fe24a9e6c23690d6/icons/raspberrypi/raspberrypi-plain.svg" alt="Logo" class="site-logo">
    <span class="site-title">RaspServerTV</span>
  </a>
  <input class="search firefox-style" id="searchBox" type="text" placeholder="Search channel...">
</header>

<div class="container">
  <aside class="sidebar" id="channelList"></aside>
  <main class="main-content">
    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 960px;"></div>
    <video id="player" controls autoplay></video>
    <div class="material-info-panel">
      <p id="channelTitle" style="display: flex; align-items: center; width: 100%;"></p>
      <span id="statusMessage" class="statusMessage"></span>
      <br><br>
      <a href="https://github.com/JonathanSanfilippo/iptv-auto-cleaner/actions" target="_blank">Auto M3U Updater</a>
      <p id="updateDate"></p>
      <p id="validCount"></p>
      <p id="skippedCount"></p>
      <p id="totalCount"></p>
      <br>
      <span>you are connect with <span id="locationInfo"></span></span>
    </div>
  </main>
  <aside class="flag-sidebar">
    <div class="country-selector" id="countrySelector"></div>
  </aside>
</div>

<footer class="main-footer">
  <p>
    &copy; <span id="year"></span>
    <a href="https://github.com/JonathanSanfilippo" target="_blank">Jonathan Sanfilippo</a> |
    <a href="https://www.paypal.com/donate" target="_blank" class="donate-link">Supporta il progetto</a>
  </p>
</footer>

<script>
  document.getElementById("year").textContent = new Date().getFullYear();

  const m3uUrls = [
    'https://raw.githubusercontent.com/JonathanSanfilippo/iptv-auto-cleaner/refs/heads/main/lists/original/original.m3u'
  ];

  let hls, allChannels = {}, currentGroup = 'UK';
  const player = document.getElementById('player');
  const channelList = document.getElementById('channelList');
  const countrySelector = document.getElementById('countrySelector');
  const searchBox = document.getElementById('searchBox');
  const statusMsg = document.getElementById('statusMessage');
  const channelTitle = document.getElementById('channelTitle');

  function parseM3UData(text, skipFlags = false) {
    const lines = text.split('\n');
    let name = '', logo = '', group = '', url = '';

    lines.forEach((line) => {
      if (line.startsWith('#EXTINF')) {
        const logoMatch = line.match(/tvg-logo="([^"]+)"/);
        const groupMatch = line.match(/group-title="([^"]+)"/);
        logo = logoMatch ? logoMatch[1] : '';
        group = groupMatch ? groupMatch[1] : 'Other';
        const parts = line.split(',');
        name = parts.length > 1 ? parts.slice(1).join(',').trim() : 'Unnamed';
      } else if (line.startsWith('http')) {
        url = line.trim();
        if (!allChannels[group]) allChannels[group] = [];
        allChannels[group].push({ name, logo, url });
      }
    });

    if (!skipFlags) {
      const countries = Object.keys(allChannels).sort();
      countries.forEach(c => createCountryFlag(c));

      fetch('https://ipinfo.io/json')
        .then(res => res.json())
        .then(ipdata => {
          const ipCountryCode = ipdata.country.toLowerCase();
          const groupName = Object.keys(allChannels).find(
            key => getCountryCode(key) === ipCountryCode
          );
          if (groupName) {
            const defaultBtn = document.querySelector(`[data-country="${groupName}"]`);
            if (defaultBtn) defaultBtn.click();
          }
          const flagUrl = `https://hatscripts.github.io/circle-flags/flags/${ipdata.country.toLowerCase()}.svg`;
          const info = `<a href='https://ipinfo.io/${ipdata.ip}' target='_blank' style='text-decoration: none; color: inherit;'>
            <img src='${flagUrl}' style=' width: 14px; vertical-align: middle;'>
            ${ipdata.country} (${ipdata.ip})
          </a>`;
          document.getElementById('locationInfo').innerHTML = info;
        })
        .catch(err => console.warn('IP info not available:', err));
    }
  }

  async function loadAllPlaylists(urls) {
    for (let i = 0; i < urls.length; i++) {
      try {
        const res = await fetch(urls[i]);
        const text = await res.text();
        parseM3UData(text, i < urls.length - 1);
      } catch (err) {
        console.error(`Error loading list ${i + 1}:`, err);
      }
    }
  }

  function playStream(url) {
    if (hls) hls.destroy();
    if (Hls.isSupported()) {
      hls = new Hls();
      hls.loadSource(url);
      hls.attachMedia(player);
      hls.on(Hls.Events.MANIFEST_PARSED, () => {
        player.play();
        statusMsg.textContent = '';
      });
      hls.on(Hls.Events.ERROR, function (event, data) {
        if (data.fatal) {
          statusMsg.textContent = "Channel not available, trying another one...";
          const visible = Array.from(document.querySelectorAll('.channel')).filter(el => el.style.display !== 'none');
          const i = visible.findIndex(el => el.dataset.url === url);
          const next = visible[i + 1];
          if (next) {
            updateChannelTitle(next.dataset.display, next.dataset.logo);
            playStream(next.dataset.url);
          } else {
            statusMsg.textContent = "No other channel available.";
          }
        }
      });
    } else if (player.canPlayType('application/vnd.apple.mpegurl')) {
      player.src = url;
      player.play();
    } else {
      alert("Your browser does not support HLS.");
    }
  }

  function updateChannelTitle(name, logo) {
    channelTitle.innerHTML = `
      <img src="${logo}" alt="Logo" style="height: 80px; max-width: 100px; object-fit: contain; margin-right: 20px;">
      <p style="font-family:Netflix Sans!important; font-weight:500; font-size:30px!important;">${name}</p>`;
  }

  function createChannelElement(name, logo, url) {
    const div = document.createElement('div');
    div.className = 'channel';
    div.dataset.url = url;
    div.dataset.name = name.toLowerCase();
    div.dataset.display = name;
    div.dataset.logo = logo;

    const img = document.createElement('img');
    img.src = logo && logo.trim() !== '' ? logo : 'https://img.icons8.com/office40/512/raspberry-pi.png';
    img.alt = name;
    img.className = 'channel-logo';

    const nameSpan = document.createElement('span');
    nameSpan.textContent = name;
    nameSpan.className = 'channel-name';

    div.appendChild(img);
    div.appendChild(nameSpan);

    div.addEventListener('click', () => {
      playStream(url);
      updateChannelTitle(name, logo);
    });

    channelList.appendChild(div);
  }

  function getCountryCode(groupName) {
    const map = {
      "uk": "gb", "usa": "us", "canada": "ca", "ireland": "ie", "australia": "au",
      "india": "in", "japan": "jp", "china": "cn", "hong kong": "hk", "macau": "mo",
      "taiwan": "tw", "north korea": "kp", "korea": "kr", "denmark": "dk",
      "faroe islands": "fo", "greenland": "gl", "finland": "fi", "iceland": "is",
      "norway": "no", "sweden": "se", "estonia": "ee", "latvia": "lv", "lithuania": "lt",
      "belgium": "be", "netherlands": "nl", "luxembourg": "lu", "germany": "de",
      "austria": "at", "switzerland": "ch", "poland": "pl", "czech republic": "cz",
      "slovakia": "sk", "hungary": "hu", "romania": "ro", "moldova": "md", "bulgaria": "bg",
      "france": "fr", "italy": "it", "portugal": "pt", "spain": "es", "russia": "ru",
      "belarus": "by", "ukraine": "ua", "armenia": "am", "azerbaijan": "az", "georgia": "ge",
      "bosnia and herzegovina": "ba", "croatia": "hr", "montenegro": "me",
      "north macedonia": "mk", "serbia": "rs", "slovenia": "si", "albania": "al",
      "kosovo": "xk", "greece": "gr", "cyprus": "cy", "andorra": "ad", "malta": "mt",
      "monaco": "mc", "san marino": "sm", "iran": "ir", "iraq": "iq", "israel": "il",
      "qatar": "qa", "turkey": "tr", "united arab emirates": "ae", "argentina": "ar",
      "costa rica": "cr", "dominican republic": "do", "mexico": "mx", "paraguay": "py",
      "peru": "pe", "venezuela": "ve", "brazil": "br", "trinidad": "tt", "chad": "td",
      "somalia": "so", "indonesia": "id"
    };
    const key = groupName.toLowerCase().trim();
    return map[key] || key;
  }

  function createCountryFlag(country) {
    const code = getCountryCode(country);
    const wrapper = document.createElement('div');
    wrapper.className = 'flag-wrapper';

    const flag = document.createElement('img');
    flag.className = 'flag';
    flag.src = `https://hatscripts.github.io/circle-flags/flags/${code}.svg`;
    flag.onerror = () => {
      flag.src = 'https://parsefiles.back4app.com/JPaQcFfEEQ1ePBxbf6wvzkPMEqKYHhPYv8boI1Rc/11113cc80977b7c9417ce4fb349cbd35_low_res_Folder_Common.png';
    };
    flag.title = country;
    flag.dataset.country = country;

    const count = allChannels[country]?.length || 0;
    const label = document.createElement('div');
    label.className = 'flag-label';
    label.textContent = `${country} (${count})`;

    wrapper.appendChild(flag);
    wrapper.appendChild(label);

    wrapper.addEventListener('click', () => {
      document.querySelectorAll('.flag-wrapper').forEach(w => w.classList.remove('selected'));
      wrapper.classList.add('selected');
      loadCountry(country);
    });

    countrySelector.appendChild(wrapper);
  }

  function loadCountry(group) {
    currentGroup = group;
    channelList.innerHTML = '';
    const channels = allChannels[group] || [];
    channels.forEach(ch => createChannelElement(ch.name, ch.logo, ch.url));
    if (channels[0]) {
      updateChannelTitle(channels[0].name, channels[0].logo);
      playStream(channels[0].url);
    }
  }

  function searchChannels() {
    const term = searchBox.value.toLowerCase();
    channelList.innerHTML = '';
    if (term === '') {
      loadCountry(currentGroup);
      return;
    }
    for (const group in allChannels) {
      allChannels[group].forEach(channel => {
        if (channel.name.toLowerCase().includes(term)) {
          createChannelElement(channel.name, channel.logo, channel.url);
        }
      });
    }
  }

  searchBox.addEventListener('input', searchChannels);
  loadAllPlaylists(m3uUrls);
</script>
<script>
  fetch('https://raw.githubusercontent.com/JonathanSanfilippo/iptv-auto-cleaner/refs/heads/main/lists/info/stats.json')
    .then(res => res.json())
    .then(stats => {
      document.getElementById('updateDate').textContent = `Last update: ${stats.last_update}`;
      document.getElementById('validCount').textContent = `Valid channels: ${stats.valid}`;
      document.getElementById('skippedCount').textContent = `Skipped channels: ${stats.skipped}`;
      document.getElementById('totalCount').textContent = `Total entries: ${stats.total}`;
    })
    .catch(err => {
      console.warn("⚠️ Impossibile caricare stats.json:", err);
      document.getElementById('updateDate').textContent = "❌ Unable to load stats.";
    });
</script>
</body>
</html>

